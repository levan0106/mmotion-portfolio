input {
  file {
    path => "/usr/share/logstash/logs/*.log"
    start_position => "beginning"
    codec => "json"
    tags => ["application-logs"]
  }
  
  beats {
    port => 5044
    tags => ["beats-logs"]
  }
}

filter {
  if "application-logs" in [tags] {
    # Parse JSON logs
    if [message] =~ /^\{.*\}$/ {
      json {
        source => "message"
      }
    }
    
    # Add timestamp
    date {
      match => [ "timestamp", "ISO8601" ]
    }
    
    # Add log level mapping
    if [level] {
      mutate {
        add_field => { "log_level" => "%{level}" }
      }
    }
    
    # Add service information
    if [service] {
      mutate {
        add_field => { "service_name" => "%{service}" }
      }
    }
    
    # Add module information
    if [module] {
      mutate {
        add_field => { "module_name" => "%{module}" }
      }
    }
  }
  
  if "beats-logs" in [tags] {
    # Process beats logs
    if [fields][log_type] == "application" {
      mutate {
        add_tag => ["application-logs"]
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "portfolio-logs-%{+YYYY.MM.dd}"
  }
  
  stdout {
    codec => rubydebug
  }
}
