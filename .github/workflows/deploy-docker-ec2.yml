name: Deploy Portfolio Application (Docker on EC2)

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - staging
        - production
      deploy_backend:
        description: 'Deploy Backend Services'
        required: true
        default: true
        type: boolean
      deploy_frontend:
        description: 'Deploy Frontend Services'
        required: true
        default: true
        type: boolean

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_BACKEND: portfolio-backend
  ECR_REPOSITORY_FRONTEND: portfolio-frontend

jobs:
  build-and-push-backend:
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') && (github.event.inputs.deploy_backend == 'true' || (github.event_name != 'workflow_dispatch' && vars.DEFAULT_DEPLOY_BACKEND != 'false'))
    outputs:
      image-tag: ${{ steps.build.outputs.image-tag }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build, tag, and push backend image
      id: build
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        set -e  # Exit on any error
        
        # Build backend image
        echo "ğŸ”¨ Building backend image..."
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:$IMAGE_TAG . || {
          echo "âŒ Backend image build failed"
          exit 1
        }
        
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:latest . || {
          echo "âŒ Backend latest image build failed"
          exit 1
        }
        
        # Push backend images
        echo "ğŸ“¤ Pushing backend images..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:$IMAGE_TAG || {
          echo "âŒ Backend image push failed"
          exit 1
        }
        
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:latest || {
          echo "âŒ Backend latest image push failed"
          exit 1
        }
        
        echo "âœ… Backend images built and pushed successfully"
        echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

  build-and-push-frontend:
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') && (github.event.inputs.deploy_frontend == 'true' || (github.event_name != 'workflow_dispatch' && vars.DEFAULT_DEPLOY_FRONTEND != 'false'))
    outputs:
      image-tag: ${{ steps.build.outputs.image-tag }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build, tag, and push frontend image
      id: build
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        set -e  # Exit on any error
        
        # Build frontend image
        echo "ğŸ”¨ Building frontend image..."
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:$IMAGE_TAG -f solution/frontend/Dockerfile solution/frontend || {
          echo "âŒ Frontend image build failed"
          exit 1
        }
        
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:latest -f solution/frontend/Dockerfile solution/frontend || {
          echo "âŒ Frontend latest image build failed"
          exit 1
        }
        
        # Push frontend images
        echo "ğŸ“¤ Pushing frontend images..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:$IMAGE_TAG || {
          echo "âŒ Frontend image push failed"
          exit 1
        }
        
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:latest || {
          echo "âŒ Frontend latest image push failed"
          exit 1
        }
        
        echo "âœ… Frontend images built and pushed successfully"
        echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy-backend:
    needs: build-and-push-backend
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') && (github.event.inputs.deploy_backend == 'true' || (github.event_name != 'workflow_dispatch' && vars.DEFAULT_DEPLOY_BACKEND != 'false'))
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Upload backend deployment files to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "solution/backend/docker-compose.yml,solution/backend/production.env,solution/backend/scripts/smart-migration.sh"
        target: "/home/${{ secrets.EC2_USER }}/mmotion-portfolio/"

    - name: Deploy Backend to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e  # Exit on any error
          
          # Update environment variables
          export ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
          export ECR_REPOSITORY_BACKEND=${{ env.ECR_REPOSITORY_BACKEND }}
          export IMAGE_TAG=${{ github.sha }}
          
          # Test ECR access first
          echo "ğŸ” Testing ECR access..."
          aws sts get-caller-identity || {
            echo "âŒ AWS credentials test failed"
            exit 1
          }
          
          # Login to ECR with retry
          echo "ğŸ”‘ Logging into ECR..."
          ECR_LOGIN_SUCCESS=false
          for i in {1..3}; do
            if aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_REGISTRY; then
              echo "âœ… ECR login successful"
              ECR_LOGIN_SUCCESS=true
              break
            else
              echo "âŒ ECR login attempt $i failed, retrying..."
              sleep 5
            fi
          done
          
          if [ "$ECR_LOGIN_SUCCESS" = false ]; then
            echo "âŒ ECR login failed after 3 attempts"
            exit 1
          fi
          
          # Pull latest backend image with retry
          echo "ğŸ“¥ Pulling backend image..."
          IMAGE_PULL_SUCCESS=false
          for i in {1..3}; do
            if docker pull $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:latest; then
              echo "âœ… Backend image pulled successfully"
              IMAGE_PULL_SUCCESS=true
              break
            else
              echo "âŒ Backend image pull attempt $i failed, retrying..."
              sleep 10
            fi
          done
          
          if [ "$IMAGE_PULL_SUCCESS" = false ]; then
            echo "âŒ Backend image pull failed after 3 attempts"
            exit 1
          fi
          
          # Ensure project directory exists
          echo "ğŸ“ Setting up project directory..."
          mkdir -p /home/${{ secrets.EC2_USER }}/mmotion-portfolio/solution/backend
          cd /home/${{ secrets.EC2_USER }}/mmotion-portfolio/solution/backend
          
          # Copy production environment file
          if [ ! -f .env ]; then
            cp production.env .env || {
              echo "âŒ Failed to copy production.env to .env"
              exit 1
            }
            echo "ğŸ“ Created .env file from production.env"
          fi
          
          # Stop and remove existing backend containers
          echo "ğŸ›‘ Stopping existing backend containers..."
          docker-compose -f docker-compose.yml down -v --remove-orphans || echo "âš ï¸ No existing containers to stop"
          
          # Force remove containers by name if they still exist
          echo "ğŸ§¹ Force removing any remaining containers..."
          docker rm -f portfolio-backend portfolio-postgres portfolio-redis 2>/dev/null || true
          
          # Start backend services
          echo "ğŸš€ Starting backend services..."
          docker-compose -f docker-compose.yml up -d || {
            echo "âŒ Failed to start backend services"
            exit 1
          }
          
          # Wait for backend to be healthy
          echo "â³ Waiting for backend to be healthy..."
          sleep 60
          
          # Run smart database migrations (only when needed)
          echo "ğŸ§  Running smart database migrations..."
          chmod +x scripts/smart-migration.sh
          
          # Try smart migration first
          if ./scripts/smart-migration.sh; then
            echo "âœ… Smart migration completed successfully"
          else
            echo "âŒ All migration attempts failed"
            exit 1
          fi
          
          # Clean up old images
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f || echo "âš ï¸ Image cleanup failed, but continuing..."
          
          echo "âœ… Backend deployment completed successfully"

  deploy-frontend:
    needs: build-and-push-frontend
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') && (github.event.inputs.deploy_frontend == 'true' || (github.event_name != 'workflow_dispatch' && vars.DEFAULT_DEPLOY_FRONTEND != 'false'))
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Upload frontend deployment files to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "solution/frontend/docker-compose.yml"
        target: "/home/${{ secrets.EC2_USER }}/mmotion-portfolio/"

    - name: Deploy Frontend to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e  # Exit on any error
          
          # Update environment variables
          export ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
          export ECR_REPOSITORY_FRONTEND=${{ env.ECR_REPOSITORY_FRONTEND }}
          export IMAGE_TAG=${{ github.sha }}
          
          # Test ECR access first
          echo "ğŸ” Testing ECR access..."
          aws sts get-caller-identity || {
            echo "âŒ AWS credentials test failed"
            exit 1
          }
          
          # Login to ECR with retry
          echo "ğŸ”‘ Logging into ECR..."
          ECR_LOGIN_SUCCESS=false
          for i in {1..3}; do
            if aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_REGISTRY; then
              echo "âœ… ECR login successful"
              ECR_LOGIN_SUCCESS=true
              break
            else
              echo "âŒ ECR login attempt $i failed, retrying..."
              sleep 5
            fi
          done
          
          if [ "$ECR_LOGIN_SUCCESS" = false ]; then
            echo "âŒ ECR login failed after 3 attempts"
            exit 1
          fi
          
          # Pull latest frontend image with retry
          echo "ğŸ“¥ Pulling frontend image..."
          IMAGE_PULL_SUCCESS=false
          for i in {1..3}; do
            if docker pull $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:latest; then
              echo "âœ… Frontend image pulled successfully"
              IMAGE_PULL_SUCCESS=true
              break
            else
              echo "âŒ Frontend image pull attempt $i failed, retrying..."
              sleep 10
            fi
          done
          
          if [ "$IMAGE_PULL_SUCCESS" = false ]; then
            echo "âŒ Frontend image pull failed after 3 attempts"
            exit 1
          fi
          
          # Ensure project directory exists
          echo "ğŸ“ Setting up project directory..."
          mkdir -p /home/${{ secrets.EC2_USER }}/mmotion-portfolio/solution/frontend
          cd /home/${{ secrets.EC2_USER }}/mmotion-portfolio/solution/frontend
          
          # Stop and remove existing frontend containers
          echo "ğŸ›‘ Stopping existing frontend containers..."
          docker-compose -f docker-compose.yml down -v --remove-orphans || echo "âš ï¸ No existing containers to stop"
          
          # Force remove containers by name if they still exist
          echo "ğŸ§¹ Force removing any remaining containers..."
          docker rm -f portfolio-frontend 2>/dev/null || true
          
          # Start frontend service
          echo "ğŸŒ Starting frontend service..."
          docker-compose -f docker-compose.yml up -d || {
            echo "âŒ Failed to start frontend service"
            exit 1
          }
          
          # Wait for frontend to be healthy
          echo "â³ Waiting for frontend to be healthy..."
          sleep 30
          
          # Check frontend health
          echo "ğŸ¥ Checking frontend health..."
          if curl -f http://localhost; then
            echo "âœ… Frontend health check passed"
          else
            echo "âŒ Frontend health check failed"
            exit 1
          fi
          
          # Clean up old images
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f || echo "âš ï¸ Image cleanup failed, but continuing..."
          
          echo "âœ… Frontend deployment completed successfully"

  health-check:
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always() && (needs.deploy-backend.result == 'success' || needs.deploy-frontend.result == 'success')
    
    steps:
    - name: Health Check
      run: |
        set -e  # Exit on any error
        
        echo "ğŸ¥ Starting health check..."
        sleep 30
        
        # Check backend health
        echo "ğŸ” Checking backend health..."
        if curl -f http://${{ secrets.EC2_HOST }}:3000/health; then
          echo "âœ… Backend health check passed"
        else
          echo "âŒ Backend health check failed"
          exit 1
        fi
        
        # Check frontend health
        echo "ğŸ” Checking frontend health..."
        if curl -f http://${{ secrets.EC2_HOST }}; then
          echo "âœ… Frontend health check passed"
        else
          echo "âŒ Frontend health check failed"
          exit 1
        fi
        
        echo "âœ… All health checks passed successfully"
